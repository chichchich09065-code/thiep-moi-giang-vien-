<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Thiệp Tri Ân Giảng Viên</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: sans-serif;
    text-align: center;
  }
  canvas {
    background: #000;
    border-radius: 12px;
    margin-top: 15px;
  }
  #controls {
    margin: 15px;
  }
  #cropArea {
    display: none;
    position: relative;
    margin: 20px auto;
    width: 300px;
    height: 300px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid #4fc3f7;
  }
  #cropArea img {
    position: absolute;
    cursor: move;
  }
</style>
</head>
<body>
  <h2>Tạo Thiệp Giảng Viên</h2>
  <div id="controls">
    <input type="file" id="upload" accept="image/*" />
    <button id="confirmCrop">Xác nhận</button>
    <button id="download">Tải ảnh về</button>
  </div>

  <div id="cropArea"><img id="preview" /></div>
  <canvas id="canvas" width="900" height="600"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const frame = new Image();
    frame.crossOrigin = "anonymous";
    frame.src = "https://raw.githubusercontent.com/chichchich09065-code/thiep-moi-giang-vien-/main/frame.png";

    const preview = document.getElementById("preview");
    const cropArea = document.getElementById("cropArea");
    let pos = { x: 0, y: 0 }, drag = false;

    // vẽ frame ngay khi load
    frame.onload = () => ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);

    // upload ảnh
    document.getElementById("upload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        cropArea.style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    // Kéo ảnh crop
    preview.addEventListener("mousedown", e => {
      drag = true;
      pos = { x: e.offsetX - preview.offsetLeft, y: e.offsetY - preview.offsetTop };
    });
    window.addEventListener("mouseup", () => drag = false);
    window.addEventListener("mousemove", e => {
      if (!drag) return;
      preview.style.left = e.clientX - pos.x + "px";
      preview.style.top = e.clientY - pos.y + "px";
    });

    // Xác nhận crop
    document.getElementById("confirmCrop").addEventListener("click", () => {
      const size = 200; // kích thước vùng tròn
      const tempCanvas = document.createElement("canvas");
      const tctx = tempCanvas.getContext("2d");
      tempCanvas.width = size;
      tempCanvas.height = size;

      tctx.save();
      tctx.beginPath();
      tctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
      tctx.closePath();
      tctx.clip();
      tctx.drawImage(preview, 0, 0, size, size);
      tctx.restore();

      const cropped = new Image();
      cropped.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.beginPath();
        ctx.arc(660, 260, 100, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(cropped, 560, 160, 200, 200);
        ctx.restore();
        ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
      };
      cropped.src = tempCanvas.toDataURL();
      cropArea.style.display = "none";
    });

    // tải về
    document.getElementById("download").addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "thiep-giang-vien.png";
      a.click();
    });
  </script>
</body>
</html>
